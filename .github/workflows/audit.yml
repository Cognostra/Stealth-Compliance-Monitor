# v3 Compliance Audit Workflow
# Runs on PRs and manual trigger with SARIF upload to GitHub Security tab

name: v3 Compliance Audit

on:
  # Run on pull requests to main/develop
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "*.md"
      - "docs/**"

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      profile:
        description: "Scan profile"
        required: true
        default: "standard"
        type: choice
        options:
          - smoke
          - standard
          - deep
      target_url:
        description: "Target URL (defaults to LIVE_URL secret)"
        required: false
        type: string
      compliance_frameworks:
        description: "Compliance frameworks to map"
        required: false
        default: "soc2,gdpr"
        type: string

concurrency:
  group: audit-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"

jobs:
  audit:
    name: Compliance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      security-events: write # Required for SARIF upload
      pull-requests: write # Required for PR comments

    services:
      zaproxy:
        image: ghcr.io/zaproxy/zaproxy:stable
        ports:
          - 8080:8080
        options: >-
          --health-cmd "curl -f http://localhost:8080/JSON/core/view/version/ || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 15
          --health-start-period 45s

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Cache Playwright Browsers
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright Browsers
        run: npx playwright install chromium --with-deps

      - name: Wait for ZAP
        run: |
          echo "Waiting for ZAP proxy..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/JSON/core/view/version/ > /dev/null; then
              echo "ZAP is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Determine Configuration
        id: config
        run: |
          # Profile
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "profile=${{ inputs.profile }}" >> $GITHUB_OUTPUT
            echo "frameworks=${{ inputs.compliance_frameworks || 'soc2,gdpr' }}" >> $GITHUB_OUTPUT
          else
            echo "profile=standard" >> $GITHUB_OUTPUT
            echo "frameworks=soc2,gdpr" >> $GITHUB_OUTPUT
          fi

          # Target URL
          if [ -n "${{ inputs.target_url }}" ]; then
            echo "url=${{ inputs.target_url }}" >> $GITHUB_OUTPUT
          else
            echo "url=${LIVE_URL_SECRET}" >> $GITHUB_OUTPUT
          fi
        env:
          LIVE_URL_SECRET: ${{ secrets.LIVE_URL }}

      - name: Run Compliance Audit
        id: audit
        run: |
          npx ts-node src/index.ts \
            --profile=${{ steps.config.outputs.profile }} \
            --sarif=reports/results.sarif \
            --compliance=${{ steps.config.outputs.frameworks }}
        env:
          CI: true
          LIVE_URL: ${{ steps.config.outputs.url }}
          ZAP_PROXY_URL: http://localhost:8080
          TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        continue-on-error: true

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('reports/results.sarif') != ''
        with:
          sarif_file: reports/results.sarif
          category: stealth-compliance-monitor

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: audit-report-${{ github.run_number }}
          path: |
            reports/
            screenshots/
          retention-days: 14

      - name: Parse Results
        id: results
        if: always()
        run: |
          if [ -f "reports/fleet-summary.json" ]; then
            SCORE=$(jq -r '.summary.averageScore // 0' reports/fleet-summary.json)
            CRITICAL=$(jq -r '.summary.totalCritical // 0' reports/fleet-summary.json)
            PASSING=$(jq -r '.summary.passingCount // 0' reports/fleet-summary.json)
            FAILING=$(jq -r '.summary.failingCount // 0' reports/fleet-summary.json)
            echo "score=$SCORE" >> $GITHUB_OUTPUT
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "passing=$PASSING" >> $GITHUB_OUTPUT
            echo "failing=$FAILING" >> $GITHUB_OUTPUT
          else
            echo "score=0" >> $GITHUB_OUTPUT
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "passing=0" >> $GITHUB_OUTPUT
            echo "failing=0" >> $GITHUB_OUTPUT
          fi

          # Count SARIF results
          if [ -f "reports/results.sarif" ]; then
            SARIF_RESULTS=$(jq -r '[.runs[].results | length] | add // 0' reports/results.sarif)
            echo "sarif_findings=$SARIF_RESULTS" >> $GITHUB_OUTPUT
          else
            echo "sarif_findings=0" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.results.outputs.score }}';
            const critical = '${{ steps.results.outputs.critical }}';
            const passing = '${{ steps.results.outputs.passing }}';
            const failing = '${{ steps.results.outputs.failing }}';
            const sarifFindings = '${{ steps.results.outputs.sarif_findings }}';
            const profile = '${{ steps.config.outputs.profile }}';
            const frameworks = '${{ steps.config.outputs.frameworks }}';

            // Determine status emoji
            let statusEmoji = '‚úÖ';
            let statusText = 'Passed';
            if (parseInt(critical) > 0) {
              statusEmoji = 'üö®';
              statusText = 'Critical Issues Found';
            } else if (parseInt(failing) > 0) {
              statusEmoji = '‚ö†Ô∏è';
              statusText = 'Issues Found';
            }

            // Build comment body
            const body = `## ${statusEmoji} Compliance Audit Results

            | Metric | Value |
            |--------|-------|
            | **Health Score** | ${score}/100 |
            | **Status** | ${statusText} |
            | **Critical Issues** | ${critical} |
            | **Security Findings** | ${sarifFindings} |
            | **Profile** | ${profile} |
            | **Frameworks** | ${frameworks} |

            ### Details
            - üìä [View SARIF Results](../security/code-scanning) (if uploaded)
            - üìÅ [Download Full Report](../actions/runs/${{ github.run_id }})

            ---
            *Stealth Compliance Monitor v3.0*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('Compliance Audit Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Set Exit Code
        if: always()
        run: |
          CRITICAL="${{ steps.results.outputs.critical }}"
          AUDIT_EXIT="${{ steps.audit.outcome }}"

          if [ "$AUDIT_EXIT" == "failure" ] || [ "$CRITICAL" != "0" ]; then
            echo "‚ùå Audit failed or critical issues found"
            exit 1
          fi
          echo "‚úÖ Audit passed"
